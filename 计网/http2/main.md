# http2

## http 1/1.1 的不足之处

1. 建立http请求的消耗太大。
建立一个http请求需要tcp三次握手并且四次挥手。而tcp连接只能并发建立有限个数量。  
在http/1.1引入keep-alive后，有两种方式可以在同一个tcp连接里复用多个http连接。

- 非流水线方式：客户端依次向服务端发送http请求，在收到上一个http请求返回后，发送下一个。
- 流水线方式：客户端一次性发送多个http请求，再进行接受。

***流水线方法的问题：队头堵塞***

由于http是无状态的，所以在流水线方式中发送多个http请求必须按序收到，否则无法判断对应的http相应请求。  
所以一旦一个http请求挂掉，在该http请求后发送的http请求必须等待并且全部重发。这就会大大降低效率。  
或者一个http请求有延迟，后面所有请求也会跟着进行大量的延迟。

2. http请求头占用体积太大
http请求头一般都是大量重复的，但每次都要重新传输，导致http报文体积增大。    

3. 明文传输不安全

## http2

http2主要为了解决传输的效率问题。解决队首堵塞和头部太大问题，并且引入一些新特性。

1. 二进制帧传输

在http2中，http报文不再以字符串明文的方式传输，而是将其分割成多个二进制的数据帧进行传输。  
用HEADER帧代表http头部，用DATA帧传输http内容。  
每个报文形成的一些帧共享相同的STREAM identifier即流标志。这代表他们同属于一个http报文。  
发送端将http报文打散成为一些数据帧，将其发送给接收方，接收方将这些帧重组获得http报文。  

2. 流传输（多路复用）

在http2中，一个http报文的传输以一个流标志。  
一个流是一个逻辑上的概念，一个流里面的数据帧共享一个流标识符。  
流中的帧不用按顺序传输，而是可以乱序传输。多个流在同一个tcp连接中进行发送。以时分多路复用的方式实现多个http报文在同一个tcp连接中进行传输。  
在流传输的前提下，一个http报文流的延迟不会引起其他http报文的延迟。因为http报文流不需要顺序接受，接受方可以通过流标志来随时重组报文。从而实现多路复用。  
注意在一个tcp连接中tcp报文段的传输仍然是按序传输的，并且同样使用窗口机制保持tcp报文传输的正确有序性（后退N步），所谓的多路复用是在http层面上，一种时分多路复用的思想。  
同时帧有对应的优先级。可以根据设定不同的优先级处理流传输的顺序，达到最好的状态。

3. 服务端推送。

在http2中，服务端可以提前在客户端请求前向客户端主动推送信息。  
比如一个客户端请求一个html，服务端可以主动推送html需要的js，css，图片。在同一个tcp连接上建立流并进行推送。客户端在收到后就不会再进行请求。

4. 头部压缩

http2中使用HPACK压缩算法进行头部压缩。  
通信双方都维持首部表来进行头部编码。  
首部表分为静态表和动态表。  
如果头部字段在静态表中直接使用静态表的序号表示。  
如果不在静态表中则需要第一次发送，双方把头部字段加入动态表中。动态表有容量限制，采用FIFO进行替换。

5. 流量控制

接受方可以指定任意的接受窗口大小。双方可以选择任意流量控制算法来进行流量控制。