# 执行上下文栈

执行上下文（以下简称“上下文”）的概念在 JavaScript 中是颇为重要的。变量或函数的上下文决定
了它们可以访问哪些数据，以及它们的行为。每个上下文都有一个关联的变量对象（variable object），
而这个上下文中定义的所有变量和函数都存在于这个对象上。虽然无法通过代码访问变量对象，但后台
处理数据会用到它。  

当js遇到一个执行函数时，就会为其创建一个执行上下文，在其真正执行的时候，就将其推进执行上下文栈中执行，执行结束后弹出执行上下文栈。  
内容包括三块

- 变量对象
- 作用域链
- this

## 变量对象

变量对象在函数创建的时候就会进行初始化，会包含

- 函数所有形参
- 内部的函数申明
- 内部的变量申明

在这里就做了变量提升

大概样子就像

```
function f(x) {
    var y = 1
    function z() {}
}
f(1)
```
会解析成
```
AO = {
    arguments:{
        x: 1,
        length: 1
    },
    y: undefined,
    z: ref to function(){}
}
```

因为此时只是进过了定义阶段，还没有执行，所以内部只做了变量提升

在进行执行后，AO会更新自己的值

```
AO = {
    ...
    y: 1 // 此时更新y为1
}
```

## 作用域链

当当前函数在本身查找不到变量的时候，会向上查找父级变量对象，这样一个个变量对象通过链表构成了作用域链。

***作用域链的本质是链表形式的变量对象***

当函数在构造阶段的时候，会创建一个内部属性```scope```，通过复制的方式将父级的变量对象添加到其中。 
在变量对象创建以后，将变量对象添加到作用域链的头部(引用) 

***作用域在函数创建时已经确定***

在函数执行时找不到该变量时，他就会沿着作用域链往上寻找变量。


## 函数执行栈执行流程

- 将全局上下文加入上下文栈中
- 创建子函数执行上下文，压入上下文栈中
- 创建子函数，将作用域保存到scope中
- 创建并初始变量对象
- 将活动对象压入scope
- 开始执行函数，修改变量对象中的值
- 返回后从上下文执行栈中出栈
